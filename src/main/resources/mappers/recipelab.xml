<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.semie.cook.mapper.RecipeLabMapper">
    <sql id="page1">
        WITH QDATA AS (
    </sql>
    <sql id="page2">
        )
        SELECT xx.*
        FROM (
        SELECT /*+ALL_ROWS*/ ROW_NUMBER() OVER(ORDER BY yy.lab_id DESC) rn
        , yy.*
        FROM QDATA yy
        ) xx
        WHERE rn BETWEEN #{start} AND #{end}
    </sql>


    <select id="selectAll" parameterType="com.semie.cook.common.Pagination" resultType="RecipeLabDTO">
        <include refid="page1" />
        SELECT
        l.lab_id,
        l.board_id,
        l.lab_name,
        l.lab_name_desc,
        l.desc_detail,
        l.create_date,
        l.modify_date,
        (SELECT file_path
        FROM img_list il
        WHERE il.post_number = l.lab_id
        and rownum=1
        AND img_priority = 1) AS poster
        FROM lab l
        LEFT OUTER JOIN img_list i
        ON l.lab_id = i.post_number
        order by l.lab_id desc
        <include refid="page2" />
    </select>

    <select id="totalLab" resultType="int">
        select count(*) from lab
    </select>

    <select id="selectById" resultType="RecipeLabDTO">
        SELECT distinct
        l.*,
        (SELECT file_path
        FROM img_list
        WHERE post_number = l.lab_id
        and rownum=1
        AND img_priority = 1) AS poster,
        LISTAGG(
        CASE
        WHEN 1=1
        THEN i.file_path
        END, ',') WITHIN GROUP (ORDER BY i.img_priority)
        OVER (PARTITION BY i.post_number) AS files
        FROM lab l
        inner JOIN img_list i
        ON l.lab_id = i.post_number
        where l.lab_id = #{lab_id}
        order by l.lab_id desc
    </select>
    <select id="selectIngredientById" resultType="hashMap">
        SELECT distinct
        l.lab_id,
        l.board_id,
        l.lab_name,
        l.lab_name_desc,
        l.desc_detail,
        l.create_date,
        l.modify_date,
        ldi.LAB_PRIORITY,
        ldi.LAB_INGREDIENT_NAME ,
        ldi.LAB_INGREDIENT_DETAIL ,
        ldi.SERVINGS,
        ldi.PREPARATION,
        ldi.COOKINGTIME,
        (
        SELECT file_path
        FROM img_list
        WHERE
        1=1
        and post_number = l.lab_id
        and rownum=1
        AND img_priority = 1) AS poster,
        LISTAGG(
        CASE
        WHEN 1=1
        THEN i.file_path
        END, ',') WITHIN GROUP (ORDER BY i.img_priority)
        OVER (PARTITION BY i.post_number) AS files
        FROM
        lab l inner JOIN img_list i ON l.lab_id = i.post_number and l.board_id = i.board_id
        inner join LAB_DETAIL_INGREDIENT ldi on l.lab_id = 1
        where
        1=1
        order by
        l.lab_id desc
    </select>
</mapper>