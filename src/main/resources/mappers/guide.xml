<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.semie.cook.mapper.GuideMapper">
    <sql id="page1">
        WITH QDATA AS (
    </sql>
    <sql id="page2">
        )
        SELECT xx.*
        FROM (
                 SELECT /*+ALL_ROWS*/ ROW_NUMBER() OVER(ORDER BY yy.GUIDE_ID ASC) rn
                    , yy.*
                 FROM QDATA yy
             ) xx
        WHERE rn BETWEEN #{start} AND #{end}
    </sql>


    <select id="selectAll" parameterType="com.semie.cook.common.Pagination" resultType="GuideDTO">
        <include refid="page1" />
        SELECT DISTINCT
        g.guide_id,
        g.board_id,
        g.guide_name,
        g.guide_desc,
        g.create_date,
        (SELECT file_path
        FROM img_list
        WHERE post_number = g.guide_id
        AND img_priority = 1) AS poster,
        LISTAGG(
        CASE
        WHEN i.img_priority != 1
        THEN i.file_path
        END, ',') WITHIN GROUP (ORDER BY i.img_priority)
        OVER (PARTITION BY i.post_number) AS files
        FROM guide g
        LEFT OUTER JOIN img_list i
        ON g.guide_id = i.post_number
        <include refid="page2" />
    </select>

    <select id="totalGuide" resultType="int">
        select count(*) from guide
    </select>

    <select id="selectById" resultType="guideDTO">
        select g.*
             , i.file_path
          from guide g
         inner join img_list i
            on g.guide_id = i.post_number
         where g.guide_id = #{guide_id}
           and i.img_priority = 1
    </select>
</mapper>